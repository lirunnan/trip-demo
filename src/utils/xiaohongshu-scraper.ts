// 小红书内容抓取工具

export interface XiaohongshuContent {
  title: string;
  content: string;
  images?: string[];
  author?: string;
  publishTime?: string;
  tags?: string[];
  location?: string;
}

/**
 * 从小红书URL中提取内容ID
 */
export function extractContentId(url: string): string | null {
  try {
    // 匹配不同格式的小红书链接
    const patterns = [
      /xiaohongshu\.com\/explore\/([a-zA-Z0-9]+)/,
      /xiaohongshu\.com\/discovery\/item\/([a-zA-Z0-9]+)/,
      /xhslink\.com\/([a-zA-Z0-9]+)/,
      /xhs\.cn\/([a-zA-Z0-9]+)/
    ];

    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match && match[1]) {
        return match[1];
      }
    }

    return null;
  } catch (error) {
    console.error('提取内容ID失败:', error);
    return null;
  }
}

/**
 * 验证小红书URL格式
 */
export function validateXiaohongshuUrl(url: string): boolean {
  if (!url || typeof url !== 'string') return false;
  
  const validDomains = [
    'xiaohongshu.com',
    'xhslink.com', 
    'xhs.cn'
  ];
  
  return validDomains.some(domain => url.includes(domain));
}

/**
 * 模拟抓取小红书内容
 * 在实际项目中，这里应该实现真实的爬虫逻辑或调用第三方API
 */
export async function scrapeXiaohongshuContent(url: string): Promise<XiaohongshuContent> {
  // 验证URL
  if (!validateXiaohongshuUrl(url)) {
    throw new Error('无效的小红书链接格式');
  }

  // 提取内容ID
  const contentId = extractContentId(url);
  if (!contentId) {
    throw new Error('无法从链接中提取内容ID');
  }

  console.log(`开始抓取小红书内容, ID: ${contentId}`);

  // 模拟网络延迟
  await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));

  // 根据URL特征返回不同的模拟数据
  const mockData = generateMockContent(url, contentId);
  
  console.log('小红书内容抓取完成:', mockData.title);
  return mockData;
}

/**
 * 生成模拟的小红书内容数据
 */
function generateMockContent(url: string, contentId: string): XiaohongshuContent {
  // 基于URL和ID生成不同的模拟内容
  const contentTemplates = [
    {
      title: "京都樱花季完美攻略｜3天2夜深度游🌸",
      content: `刚从京都回来，樱花季真的太美了！分享一下我的3天行程：

Day 1: 传统文化体验
🏛️ 清水寺 (8:00-10:00)
- 早上人少，樱花配古建筑超美
- 门票400日元，建议穿和服拍照
- 地址：京都市东山区清水1-294

🛍️ 二年坂三年坂 (10:00-12:00) 
- 传统街道，各种小店和纪念品
- 推荐买京都限定的抹茶点心
- 石板路比较滑，穿舒适的鞋子

🥢 午餐：权太呂本店 (12:00-13:30)
- 百年老店的乌冬面，汤头超鲜美
- 人均1500日元，需要排队

⛩️ 金阁寺 (14:00-16:00)
- 下午光线最好，金色倒影绝美
- 门票500日元，樱花季人很多
- 建议从不同角度多拍几张

Day 2: 岚山自然风光
🎋 岚山竹林 (9:00-10:30)
- 绿意盎然，仿佛进入仙境
- 免费参观，早上光影效果最佳
- 可以租自行车游览

🏯 天龙寺 (10:30-12:00)
- 世界文化遗产，庭院樱花很美
- 门票600日元，有英文导览

🍜 午餐：嵯峨野汤豆腐料理 (12:00-13:30)
- 京都特色豆腐料理，清淡养生
- 人均3000日元，环境很雅致

🌉 渡月桥 (15:00-17:00)
- 岚山标志性景点，夕阳西下时最美
- 免费参观，可以在桂川边散步
- 附近有很多樱花树

Day 3: 哲学之道漫步
🏛️ 银阁寺 (9:00-10:30)
- 东山文化的代表，幽静雅致
- 门票500日元，庭院设计很精美

🌸 哲学之道 (10:30-12:00)
- 樱花隧道，浪漫至极
- 全程约2公里，慢慢走很舒服
- 两旁有很多咖啡店可以休息

🍱 午餐：菊乃井 (12:30-14:00)
- 米其林三星怀石料理（需提前预约）
- 人均15000日元，体验正宗京料理

⛩️ 南禅寺 (14:30-16:00)
- 京都五山之首，建筑宏伟
- 门票免费，登上山门可俯瞰京都
- 秋天红叶季也很美

💡 实用Tips：
1. 樱花季（3月下旬-4月上旬）是旺季，住宿和交通都要提前预订
2. 买京都市巴士一日券（600日元）很划算
3. 大部分寺庙17:00关门，安排行程要注意时间
4. 推荐住在京都站附近，交通便利
5. 和服租赁建议选择清水寺附近的店铺
6. 京都人说话比较轻声，注意保持安静

💰 预算参考（2人）：
- 住宿：商务酒店 12000日元/晚 × 2晚
- 交通：关西机场往返 + 市内交通 约8000日元
- 门票：各景点门票合计约3000日元
- 餐饮：人均8000日元/天 × 3天
- 购物纪念品：因人而异
总计约60000日元（不含购物）

这次京都之行真的太满足了，每个角落都是明信片般的美景！强烈推荐大家樱花季去体验一下～`,
      author: "旅行达人小美",
      publishTime: "2024-03-15",
      tags: ["京都旅游", "樱花季", "日本自由行", "古寺参观", "和服体验", "怀石料理"],
      location: "京都, 日本"
    },
    {
      title: "丽江古城慢生活｜7天深度游攻略✨",
      content: `在丽江待了一周，彻底爱上了这里的慢时光！

🏮 Day1-2: 大研古城初体验
📍 四方街 - 古城的心脏地带
- 白天逛各种手工艺品店
- 晚上听纳西古乐，很有韵味
- 推荐买手工银饰和东巴纸

📍 木府 - 纳西族的紫禁城
- 门票60元，建筑很壮观
- 了解纳西族历史文化
- 登高可以俯瞰古城全景

🍜 美食推荐：
- 阿安酸奶：酸奶紫米露绝了！
- 小锅巴纳西菜：当地特色菜
- 88号小吃店：鸡豆凉粉很正宗

🗻 Day3-4: 玉龙雪山震撼之旅
📍 玉龙雪山大索道
- 门票+索道往返680元
- 海拔4506米，记得带氧气瓶
- 山顶雪景震撼，但要注意高反

📍 蓝月谷
- 水真的是蒂芙尼蓝色！
- 可以坐电瓶车游览各个湖泊
- 拍照超美，像人间仙境

📍 印象丽江演出
- 张艺谋导演的实景演出
- 票价280-680元不等
- 以玉龙雪山为背景，很震撼

🌸 Day5-6: 束河古镇静谧时光
📍 束河古镇
- 比大研古城安静，适合发呆
- 古镇维护费40元
- 青石板路，小桥流水很诗意

📍 茶马古道博物馆
- 了解茶马古道历史
- 门票30元，有很多珍贵文物
- 可以体验骑马走茶马古道

📍 青龙桥
- 束河标志性建筑
- 明朝时期的石拱桥
- 夕阳西下时拍照最美

☕ Day7: 咖啡店慢时光
推荐几家超棒的咖啡店：

📍 猫的天空之城
- 文艺青年必去！
- 可以给未来的自己寄明信片
- 咖啡和甜品都不错

📍 小巴黎咖啡馆
- 法式风情，环境很浪漫
- 手冲咖啡很专业
- 可以坐一下午看书发呆

📍 背包客咖啡
- 很多旅行者聚集地
- 可以交流旅行经验
- 价格亲民，氛围很好

🏠 住宿推荐：
1. 大研古城内的客栈：体验古城夜晚
2. 束河古镇客栈：更安静，适合休息
3. 新城区酒店：设施现代，交通方便

🚗 交通tips：
- 机场大巴20元到古城
- 古城内步行即可，也可租自行车
- 去玉龙雪山建议包车或跟团

💡 实用建议：
1. 丽江紫外线很强，一定要防晒
2. 早晚温差大，记得带外套
3. 高原反应因人而异，慢慢适应
4. 古城维护费80元要保留好票据
5. 不要轻信拉客的，选择正规旅行社
6. 尊重当地纳西族文化和习俗

💰 预算参考（单人7天）：
- 住宿：客栈150元/晚 × 6晚 = 900元
- 交通：往返机票 + 当地交通约1500元
- 门票：古城维护费 + 各景点约500元
- 餐饮：人均80元/天 × 7天 = 560元
- 购物纪念品：500-1000元
总计约4000-5000元

丽江真的是一个来了就不想走的地方，这里的慢时光会让你重新思考生活的意义。推荐大家至少待一周，才能真正体验到丽江的魅力～`,
      author: "文艺女青年小雯",
      publishTime: "2024-03-10",
      tags: ["丽江古城", "慢旅行", "文艺旅行", "玉龙雪山", "纳西文化", "束河古镇"],
      location: "丽江, 云南"
    },
    {
      title: "新疆独库公路自驾｜天路震撼7日游🏔️",
      content: `刚跑完独库公路，真的是此生必去的自驾路线！

🚗 路线规划（7天6晚）：
Day1: 乌鲁木齐 → 乔尔玛 (280km, 4小时)
住宿：乔尔玛宾馆（条件一般但干净）

Day2: 乔尔玛 → 巴音布鲁克 (140km, 3小时)
住宿：巴音布鲁克天鹅湖宾馆

Day3: 巴音布鲁克 → 那拉提 (90km, 2小时)
住宿：那拉提草原度假村

Day4: 那拉提 → 伊宁 (260km, 4小时)
住宿：伊宁市区酒店

Day5: 伊宁 → 赛里木湖 (120km, 2小时)
住宿：赛里木湖边蒙古包

Day6: 赛里木湖 → 克拉玛依 (450km, 6小时)
住宿：克拉玛依市区酒店

Day7: 克拉玛依 → 乌鲁木齐 (280km, 4小时)

🌟 必看景点详解：

📍 天山神秘大峡谷
- 红色砂岩峡谷，鬼斧神工
- 门票45元，游览时间2-3小时
- 最佳拍照时间：下午3-5点
- 注意：峡谷内比较凉，带件外套

📍 大小龙池
- 高山湖泊，湖水如翡翠般清澈
- 免费景点，停车拍照即可
- 海拔较高，注意保暖
- 湖边有哈萨克族毡房，可以体验

📍 巴音布鲁克草原
- 中国最美湿地草原
- 门票65元+区间车90元
- 九曲十八弯日落绝美！
- 建议下午4点进入，等待日落

📍 那拉提空中草原
- 伊犁最美草原，花海如画
- 门票95元+区间车40元
- 6-8月野花盛开，美得不真实
- 可以骑马体验哈萨克族文化

📍 赛里木湖
- "大西洋最后一滴眼泪"
- 门票70元+区间车75元
- 湖水蓝得让人心醉
- 环湖一圈约90公里，开车2小时

🍖 美食推荐：
1. 手抓饭：新疆特色，羊肉配胡萝卜丁
2. 大盘鸡：辣中带香，配面条绝了
3. 烤包子：外酥内嫩，羊肉馅很香
4. 馕坑肉：传统做法，肉质鲜美
5. 马奶子：哈萨克族传统饮品
6. 酸奶疙瘩：很特别的奶制品

⚠️ 重要注意事项：
1. 通车时间：6月-10月，其他时间封路
2. 全程限速，测速很多，千万别超速
3. 加油要及时，服务区间距较远
4. 高海拔地区注意高反，备好药品
5. 天气变化快，带好各季节衣物
6. 手机信号时有时无，下载离线地图
7. 尊重少数民族习俗和宗教信仰

🚙 车辆准备：
- 建议SUV或越野车，底盘高通过性好
- 出发前全面检查车况
- 备胎、工具箱、拖车绳必备
- 车载充电器、逆变器很实用
- 准备足够的机油和玻璃水

🎒 装备清单：
- 冲锋衣、抓绒衣、羽绒服
- 防晒霜SPF50+、墨镜、帽子
- 常用药品：感冒药、肠胃药、高反药
- 保温杯、干粮、零食
- 相机、充电宝、数据线
- 现金（很多地方不能刷卡）

💰 费用预算（2人）：
- 租车：600元/天 × 7天 = 4200元
- 油费：约2000元
- 过路费：约500元
- 住宿：200-400元/晚 × 6晚 = 1800元
- 门票：约800元
- 餐饮：200元/天 × 7天 = 1400元
总计约10700元

独库公路真的是中国最美的公路之一，沿途风光从荒漠到草原到雪山，像是穿越了四季。虽然路程有些颠簸，但绝对值得！建议大家一定要在6-8月的最佳季节去，那时候草原最美，野花盛开～

记得带好装备，注意安全，享受这段难忘的天路之旅！🚗💨`,
      author: "自驾达人阿力",
      publishTime: "2024-03-08",
      tags: ["独库公路", "新疆自驾", "草原", "天山", "赛里木湖", "巴音布鲁克"],
      location: "新疆"
    }
  ];

  // 根据URL或contentId选择不同的模板
  let selectedTemplate;
  if (url.includes('kyoto') || url.includes('japan') || contentId.includes('kyoto')) {
    selectedTemplate = contentTemplates[0];
  } else if (url.includes('lijiang') || url.includes('yunnan') || contentId.includes('lijiang')) {
    selectedTemplate = contentTemplates[1];
  } else if (url.includes('xinjiang') || url.includes('duku') || contentId.includes('xinjiang')) {
    selectedTemplate = contentTemplates[2];
  } else {
    // 随机选择一个模板
    selectedTemplate = contentTemplates[Math.floor(Math.random() * contentTemplates.length)];
  }

  return {
    ...selectedTemplate,
    images: ['/images/placeholder.png'] // 模拟图片URL
  };
}
